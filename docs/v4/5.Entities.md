Entities are the variables that can be used in XML content to maintain consistency. Eg,

```xml
<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE note [
<!ENTITY nbsp "&#xA0;">
<!ENTITY writer "Writer: Donald Duck.">
<!ENTITY copyright "Copyright: W3Schools.">
]>

<note>
    <to>Tove</to>
    <from>Jani</from>
    <heading>Reminder</heading>
    <body attr="&writer;">Don't forget me this weekend!</body>
    <footer>&writer;&nbsp;&copyright;</footer>
</note> 
```

You can define your own entities using DOCTYPE. FXP by default supports following XML entities:

| Entity name | Character | Decimal reference | Hexadecimal reference |
| :---------- | :-------- | :---------------- | :-------------------- |
| quot        | "         | `&#34;`           | `&#x22;`              |
| amp         | &         | `&#38;`           | `&#x26;`              |
| apos        | '         | `&#39;`           | `&#x27;`              |
| lt          | <         | `&#60;`           | `&#x3C;`              |
| gt          | >         | `&#62;`           | `&#x3E;`              |

## processEntities Configuration

**Type:** `Boolean | Object`  
**Default:** `true`

Controls how the parser handles XML entities with built-in security protections.

### Basic Usage

```js
// Disable entity processing (recommended for untrusted XML)
const parser = new XMLParser({ 
  processEntities: false 
});

// Enable with default security limits (safe for most use cases)
const parser = new XMLParser({ 
  processEntities: true 
});
```

### Security Limits (Advanced)

When `processEntities: true`, the parser applies these default limits to prevent denial-of-service attacks:

```js
const parser = new XMLParser({
  processEntities: {
    enabled: true,              // Master switch
    maxEntitySize: 10000,       // Max 10KB per entity definition
    maxTotalExpansions: 1000,   // Max 1000 entity replacements total
    maxExpandedLength: 100000   // Max 100KB total expanded content
  }
});
```

**Recommendations:**
- **For untrusted XML:** Use `processEntities: false` 
- **For trusted XML with entities:** Use `processEntities: true` (default limits are safe)
- **For custom security needs:** Configure limits based on your requirements

### How It Works

**When `false`:**
- The parser recognizes `<!DOCTYPE>` and `<!ENTITY>` tags
- Entity references like `&writer;` are **not** replaced - they remain as-is in the output
- Prevents Entity Expansion attacks while allowing DOCTYPE parsing
- **Best for:** Public APIs, untrusted XML sources, maximum security

**When `true`:**
- The parser actively replaces all `&entity;` references with their defined values
- Security limits prevent resource exhaustion attacks
- **Best for:** Internal systems, trusted XML sources, when entities are needed

### Security Protections

FXP includes multiple defense layers against entity expansion attacks:

1. **Entity Size Limit:** Prevents individual entities from being too large
2. **Expansion Count Limit:** Prevents too many entity replacements
3. **Total Size Limit:** Prevents output from growing too large
4. **Parameter Entity Blocking:** Entities containing `&` are automatically ignored

These protections defend against:
- Billion Laughs attack (exponential entity expansion)
- Memory exhaustion attacks
- CPU exhaustion attacks

**Example of blocked attack:**
```xml
<!DOCTYPE foo [
  <!ENTITY big "AAAAA..."> <!-- 50KB entity -->
]>
<root>&big;&big;&big;...</root> <!-- 1000+ repetitions -->
```
This would be blocked at the entity definition stage or during expansion, preventing resource exhaustion.

## XML Builder

XML Builder decodes default entities automatically. Eg:

```js
const jsObj = {
    "note": {
        "@heading": "Reminder > \"Alert",
        "body": {
            "#text": " 3 < 4",
            "attr": "Writer: Donald Duck."
        },
    }
};

const options = {
    attributeNamePrefix: "@",
    ignoreAttributes: false,
};
const builder = new XMLBuilder(options);
const output = builder.build(jsObj);
```

Output:
```xml
<note heading="Reminder &gt; &quot;Alert">
    <body>
        3 &lt; 4
        <attr>Writer: Donald Duck.</attr>
    </body>
</note>
```

## Side Effects

FXP silently ignores entities with `&` in their values for security. However, be aware of how multiple entities interact:

```xml
<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE note [
<!ENTITY nbsp "writer;">
<!ENTITY writer "Writer: Donald Duck.">
<!ENTITY copyright "Copyright: W3Schools.">
]>

<note>
    <heading>Reminder</heading>
    <body attr="&writer;">Don't forget me this weekend!</body>
    <footer>&writer;&&nbsp;&copyright;</footer>
</note> 
```

Output:

```js
{
    "note": {
        "heading": "Reminder",
        "body": {
            "#text": "Don't forget me this weekend!",
            "attr": "Writer: Donald Duck."
        },
        "footer": "Writer: Donald Duck.Writer: Donald Duck.Copyright: W3Schools."
    }
}
```

To deal with literal ampersands, use `&amp;` in your XML document.

## Security Note

While FXP blocks many entity-based attacks through its security limits and by rejecting entities with `&` in values, the following attack vectors are mitigated:

* **Denial-of-Service Attacks:** Blocked by size and expansion limits
* **Classic XXE:** External entities are not supported
* **Parameter Entities:** Automatically ignored
* **Recursive Entities:** Blocked by refusing entities containing `&`

**When `processEntities: false`:** All entity expansion is disabled, providing maximum security for untrusted XML.

## HTML Entities

Following HTML entities are supported when `htmlEntities: true`:

| Result | Description                        | Entity Name | Entity Number |
| :----- | :--------------------------------- | :---------- | :------------ |
|        | non-breaking space                 | `&nbsp;`    | `&#160;`      |        
| <      | less than                          | `&lt;`      | `&#60;`       |        
| >      | greater than                       | `&gt;`      | `&#62;`       |        
| &      | ampersand                          | `&amp;`     | `&#38;`       |        
| "      | double quotation mark              | `&quot;`    | `&#34;`       |        
| '      | single quotation mark              | `&apos;`    | `&#39;`       |        
| ¢      | cent                               | `&cent;`    | `&#162;`      |        
| £      | pound                              | `&pound;`   | `&#163;`      |        
| ¥      | yen                                | `&yen;`     | `&#165;`      |        
| €      | euro                               | `&euro;`    | `&#8364;`     |        
| ©      | copyright                          | `&copy;`    | `&#169;`      |        
| ®      | registered trademark               | `&reg;`     | `&#174;`      |        
| ₹      | Indian Rupee                       | `&inr;`     | `&#8377;`     |

In addition, [numeric character references](https://html.spec.whatwg.org/multipage/syntax.html#syntax-charref) are supported - both decimal (`&#123;`) and hexadecimal (`&#x7B;`).

FXP supports reading Notations and Elements from v5.2.1 onwards. However, it doesn't take any action based on these values.

## External Entities

You can add external entities programmatically without using DOCTYPE:

```js
const xmlData = `<note>&unknown;&#xD;last</note>`;

const parser = new XMLParser();
parser.addEntity("#xD", "\r");
let result = parser.parse(xmlData); // Output: &unknown;\rlast
```

This method also allows you to override default entities.

**Note:** External entities added this way bypass DOCTYPE validation but are still subject to the same security limits when `processEntities: true`.

[> Next: HTML Document Parsing](./6.HTMLParsing.md)